{% extends "base.html" %}

{% block title %}{{ member.get_full_name|default:member.username }} - AI Club{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <!-- Member Profile Card -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-lg">
                <div class="card-body text-center">
                    <!-- Profile Picture -->
                    {% if member.profile_picture %}
                    <img src="{{ member.profile_picture.url }}" alt="{{ member.username }}"
                        style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 4px solid #0d47a1;">
                    {% else %}
                    <div
                        style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #0d47a1 0%, #1e88e5 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 3rem; color: white; border: 4px solid #0d47a1;">
                        <i class="fas fa-user"></i>
                    </div>
                    {% endif %}

                    <!-- Basic Info -->
                    <h3>{{ member.get_full_name|default:member.username }}</h3>
                    <p class="text-muted">@{{ member.username }}</p>
                    <span class="badge bg-primary">{{ member.get_role_display }}</span>

                    <!-- Edit Profile Button (if own profile) -->
                    {% if user == member %}
                    <div class="mt-3">
                        <a href="{% url 'edit_profile' %}" class="btn btn-primary w-100">
                            <i class="fas fa-edit"></i> Edit Profile
                        </a>
                    </div>
                    {% endif %}

                    <!-- Manage Role Button (Admin/Owner/President) -->
                    {% if can_manage_roles %}
                    <div class="mt-3">
                        <button type="button" class="btn btn-warning w-100" id="manageRoleBtn">
                            <i class="fas fa-user-tag"></i> Manage Roles
                        </button>
                    </div>
                    {% endif %}
                    <hr>

                    <!-- Contact Info -->
                    {% if member.phone %}
                    <p class="mb-2">
                        <i class="fas fa-phone"></i> {{ member.phone }}
                    </p>
                    {% endif %}

                    {% if member.email %}
                    <p class="mb-2">
                        <i class="fas fa-envelope"></i> {{ member.email }}
                    </p>
                    {% endif %}

                    <!-- Social Links -->
                    {% if member.github_url or member.linkedin_url %}
                    <div class="mt-3">
                        {% if member.github_url %}
                        <a href="{{ member.github_url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fab fa-github"></i> GitHub
                        </a>
                        {% endif %}
                        {% if member.linkedin_url %}
                        <a href="{{ member.linkedin_url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fab fa-linkedin"></i> LinkedIn
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Stats -->
                    <div class="row mt-4 text-center">
                        <div class="col-6">
                            <strong>{{ total_attended }}</strong><br>
                            <small class="text-muted">Events Attended</small>
                        </div>
                        <div class="col-6">
                            <strong>{{ registered_events.count }}</strong><br>
                            <small class="text-muted">Registered</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Member Details -->
        <div class="col-md-8">
            <!-- Bio -->
            {% if member.bio %}
            <div class="card shadow-lg mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-quote-left"></i> About</h5>
                </div>
                <div class="card-body">
                    {{ member.bio }}
                </div>
            </div>
            {% endif %}

            <!-- Skills -->
            {% if member.skills %}
            <div class="card shadow-lg mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-code"></i> Skills</h5>
                </div>
                <div class="card-body">
                    <p>{{ member.skills }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Attended Events -->
            {% if attended_events %}
            <div class="card shadow-lg mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-check-circle"></i> Events Attended ({{ attended_events.count }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for registration in attended_events %}
                        <a href="{% url 'event_detail' registration.event.id %}"
                            class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ registration.event.title }}</h6>
                                    <small class="text-muted">{{ registration.event.date|date:"d/m/Y H:i" }}</small>
                                </div>
                                <span class="badge bg-success">Attended</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Registered Events -->
            {% if registered_events %}
            <div class="card shadow-lg">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar-check"></i> Upcoming Events ({{ registered_events.count }})</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for registration in registered_events %}
                        <a href="{% url 'event_detail' registration.event.id %}"
                            class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ registration.event.title }}</h6>
                                    <small class="text-muted">{{ registration.event.date|date:"d/m/Y H:i" }}</small>
                                </div>
                                <span class="badge bg-warning">Registered</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Role Management Modal - Rebuilt for stability -->
<div id="roleModalBackdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040;"></div>

<div id="roleModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050; width: 90%; max-width: 500px;">
    <div style="background-color: white; border-radius: 0.25rem; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);">
        <!-- Header -->
        <div style="padding: 1rem; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin: 0; font-size: 1.25rem;">Manage Roles for {{ member.username }}</h5>
            <button id="closeRoleModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">&times;</button>
        </div>

        <!-- Body -->
        <form action="{% url 'manage_user_role' member.id %}" method="POST" id="roleForm">
            {% csrf_token %}
            <div style="padding: 1.5rem;">
                <!-- Primary Role -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Primary Role</label>
                    <select name="role" style="width: 100%; padding: 0.375rem 0.75rem; border: 1px solid #ced4da; border-radius: 0.25rem; font-size: 1rem;">
                        {% for code, name in role_choices %}
                        <option value="{{ code }}" {% if member.role == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Secondary Role -->
                <div style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Secondary Role (Optional)</label>
                    <select name="secondary_role" style="width: 100%; padding: 0.375rem 0.75rem; border: 1px solid #ced4da; border-radius: 0.25rem; font-size: 1rem;">
                        <option value="">-- None --</option>
                        {% for code, name in role_choices %}
                        <option value="{{ code }}" {% if member.secondary_role == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Footer -->
            <div style="padding: 1rem; border-top: 1px solid #dee2e6; display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="button" id="cancelRoleModal" style="padding: 0.375rem 0.75rem; background-color: #6c757d; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 1rem;">Cancel</button>
                <button type="submit" style="padding: 0.375rem 0.75rem; background-color: #0d47a1; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 1rem;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* No Bootstrap modal styles - prevent any conflicts */
    #roleModal select {
        box-sizing: border-box;
    }

    #roleModal select:focus {
        border-color: #0d47a1;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(13, 71, 161, 0.25);
    }

    #roleModal button[type="submit"]:hover {
        background-color: #0a3575 !important;
    }

    #roleModal button[type="button"]:hover {
        background-color: #5a6268 !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const manageRoleBtn = document.getElementById('manageRoleBtn');
    const closeRoleModal = document.getElementById('closeRoleModal');
    const cancelRoleModal = document.getElementById('cancelRoleModal');
    const roleModal = document.getElementById('roleModal');
    const roleModalBackdrop = document.getElementById('roleModalBackdrop');

    if (manageRoleBtn) {
        manageRoleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            roleModal.style.display = 'block';
            roleModalBackdrop.style.display = 'block';
        });
    }

    function closeModal() {
        roleModal.style.display = 'none';
        roleModalBackdrop.style.display = 'none';
    }

    if (closeRoleModal) {
        closeRoleModal.addEventListener('click', closeModal);
    }

    if (cancelRoleModal) {
        cancelRoleModal.addEventListener('click', closeModal);
    }

    if (roleModalBackdrop) {
        roleModalBackdrop.addEventListener('click', closeModal);
    }
});
</script>
{% endblock %}