{% extends 'base.html' %}

{% block title %}Mon Historique de Chat{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>üí¨ Mon Historique de Chat</h1>
            <p class="text-muted">Historique personnel de vos conversations avec l'assistant</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'assistant:chat' %}" class="btn btn-primary">
                <i class="fas fa-comments"></i> Retour au Chat
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Messages</h5>
                    <h2 class="text-primary">{{ total_messages }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">R√©ponses FAQ</h5>
                    <h2 class="text-info">{{ faq_messages }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Commandes</h5>
                    <h2 class="text-success">{{ command_messages }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-muted">Vous</h5>
                    <h2 class="text-warning">{{ user_name|truncatewords:2 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìù Vos Conversations</h5>
            <button class="btn btn-sm btn-danger" id="clear-history-btn">
                <i class="fas fa-trash"></i> Effacer tout
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 30%;">Votre Message</th>
                        <th style="width: 40%;">R√©ponse</th>
                        <th style="width: 15%;">Type</th>
                        <th style="width: 15%;">Date/Heure</th>
                    </tr>
                </thead>
                <tbody>
                    {% for message in page_obj %}
                        <tr style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#msg-{{ message.id }}" aria-expanded="false">
                            <td>
                                <strong>{{ message.message|truncatewords:8 }}</strong>
                            </td>
                            <td>
                                <p class="mb-0 text-muted">{{ message.response|truncatewords:10|striptags }}</p>
                            </td>
                            <td>
                                {% if message.is_faq %}
                                    <span class="badge bg-info">üìö FAQ</span>
                                {% else %}
                                    <span class="badge bg-success">‚öôÔ∏è Commande</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">{{ message.created_at }}</small>
                            </td>
                        </tr>
                        
                        <!-- Details Row -->
                        <tr class="collapse" id="msg-{{ message.id }}">
                            <td colspan="4">
                                <div class="p-3 bg-light">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Votre Message</h6>
                                            <div class="bg-white p-2 border rounded" style="max-height: 150px; overflow-y: auto;">
                                                <p class="mb-0">{{ message.message }}</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>R√©ponse de l'Assistant</h6>
                                            <div class="bg-white p-2 border rounded" style="max-height: 150px; overflow-y: auto;">
                                                <p class="mb-0">{{ message.response }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% if message.category %}
                                        <div class="mt-2">
                                            <small class="text-muted">Cat√©gorie: <strong>{{ message.category }}</strong></small>
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <p class="text-muted">
                                    <i class="fas fa-inbox"></i> Aucun message encore
                                </p>
                                <a href="{% url 'assistant:chat' %}" class="btn btn-primary btn-sm">
                                    Commencer √† chatter
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">Premi√®re</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Pr√©c√©dente</a>
                    </li>
                {% endif %}

                <li class="page-item disabled">
                    <span class="page-link">
                        Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
                    </span>
                </li>

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Suivante</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Derni√®re</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}

</div>

<script>
    const clearBtn = document.getElementById('clear-history-btn');
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer tout votre historique de chat? Cette action ne peut pas √™tre annul√©e.')) {
                fetch('{% url "assistant:clear_history" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .collapse {
        display: table-row;
    }
    
    .collapse.show {
        display: table-row;
    }
    
    .collapse:not(.show) {
        display: none;
    }
</style>
{% endblock %}
